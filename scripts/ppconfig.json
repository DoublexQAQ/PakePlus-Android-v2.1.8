{"name":"cbfcefea","url":"https://www.acgkkkk.com/","showName":"ACG动漫","appid":"com.cbfcefea.pakeplus","icon":"","iconPath":"C:\\Users\\lisen\\AppData\\Roaming\\com.pakeplus.pacbao\\zcuzdnwz1v.png","iconRound":true,"state":true,"single":true,"injectJq":true,"tauriApi":false,"devbug":false,"version":"1.0.4","preview":"desktop","platform":["1-1"],"width":800,"height":600,"desc":"","jsFile":[],"filterCss":"","customJs":"// very important, if you don't know what it is, don't touch it\n// 非常重要，不懂代码不要动，这里可以解决80%的问题，也可以生产1000+的bug\nconst hookClick = (e) => {\n    const origin = e.target.closest('a')\n    const isBaseTargetBlank = document.querySelector(\n        'head base[target=\"_blank\"]'\n    )\n    console.log('origin', origin, isBaseTargetBlank)\n    if (\n        (origin && origin.href && origin.target === '_blank') ||\n        (origin && origin.href && isBaseTargetBlank)\n    ) {\n        e.preventDefault()\n        console.log('handle origin', origin)\n        location.href = origin.href\n    } else {\n        console.log('not handle origin', origin)\n    }\n}\n\nwindow.open = function (url, target, features) {\n    console.log('open', url, target, features)\n    location.href = url\n}\n\ndocument.addEventListener('click', hookClick, { capture: true });\n\n(function () {\n  'use strict';\n  if (window.__ACG_SAFE_INJECT__) return;\n  window.__ACG_SAFE_INJECT__ = true;\n\n  console.log('[ACG-HOOK] init');\n\n  // === 配置 ===\n  const IS_MOBILE = /Android|iPhone|iPad/i.test(navigator.userAgent);\n  const VIDEO_WAIT_TIMEOUT = 20000; // 等视频最长 20s\n  const OBS_POLL = 500;\n  const SAFE_HOOK_DELAY = 1500; // 发现播放器后，延迟多少 ms 再 hook fetch/xhr（降低被检测概率）\n\n  // 捕获到的视频 URL 集合（保持顺序）\n  const videoUrls = [];\n\n  function addVideoUrl(u) {\n    if (!u) return;\n    try {\n      // 去掉断言参数（常见的 token 参数不影响显示）\n      const clean = u.split('#')[0];\n      if (!videoUrls.includes(clean)) {\n        videoUrls.push(clean);\n        console.log('[ACG-HOOK] captured:', clean);\n        updateDownloadMenu();\n      }\n    } catch (e) {}\n  }\n\n  // === 广告/弹窗隐藏（保守型，只 hide 明确类名或常见遮罩） ===\n  const safeCss = `\n    .ads, .ad, .banner, .popup, .modal, .mask, .cookie-consent {\n      display: none !important;\n      opacity: 0 !important;\n      pointer-events: none !important;\n    }\n  `;\n  try {\n    const style = document.createElement('style');\n    style.id = '__acg_hide_style';\n    style.textContent = safeCss;\n    document.head && document.head.appendChild(style);\n  } catch (e) {\n    console.warn('[ACG-HOOK] css inject failed', e);\n  }\n\n  // === UI: 下载按钮 / 菜单 ===\n  function createDownloadUI() {\n    if (document.getElementById('__acg_download_btn')) return;\n    const box = document.createElement('div');\n    box.id = '__acg_download_btn';\n    box.style.cssText = `\n      position: fixed;\n      top: 12px;\n      right: 12px;\n      z-index: 999999;\n      display: flex;\n      gap:8px;\n      align-items:center;\n      font-family: Arial, Helvetica, sans-serif;\n    `;\n\n    const btn = document.createElement('button');\n    btn.textContent = '⬇ 下载';\n    btn.style.cssText = `\n      background: rgba(0,0,0,0.66);\n      color: #fff;\n      border: none;\n      padding: 8px 10px;\n      border-radius: 6px;\n      cursor: pointer;\n    `;\n    btn.onclick = () => {\n      if (!videoUrls.length) return alert('未捕获到视频地址，请先播放视频或等待片刻。');\n      const last = videoUrls[videoUrls.length - 1];\n      if (/\\.m3u8(\\?|$)/i.test(last)) {\n        prompt('检测到 m3u8，请复制地址并用 ffmpeg/N_m3u8DL 下载：', last);\n      } else {\n        // 直接打开 mp4 链接\n        window.open(last, '_blank');\n      }\n    };\n\n    const menu = document.createElement('select');\n    menu.style.cssText = `\n      background: rgba(255,255,255,0.95);\n      border-radius: 6px;\n      padding: 6px;\n    `;\n    menu.id = '__acg_download_menu';\n    menu.onchange = () => {\n      const v = menu.value;\n      if (!v) return;\n      if (/\\.m3u8(\\?|$)/i.test(v)) {\n        prompt('m3u8 链接：', v);\n      } else {\n        window.open(v, '_blank');\n      }\n    };\n\n    box.appendChild(btn);\n    box.appendChild(menu);\n    document.body.appendChild(box);\n    updateDownloadMenu();\n  }\n\n  function updateDownloadMenu() {\n    const menu = document.getElementById('__acg_download_menu');\n    if (!menu) return;\n    // clear\n    menu.innerHTML = '';\n    const empty = document.createElement('option');\n    empty.value = '';\n    empty.textContent = videoUrls.length ? '选择清晰度 / 链接' : '未捕获到视频';\n    menu.appendChild(empty);\n    videoUrls.forEach(u => {\n      const o = document.createElement('option');\n      o.value = u;\n      o.textContent = (u.length > 60 ? '…' + u.slice(-60) : u);\n      menu.appendChild(o);\n    });\n  }\n\n  // === 读取 video.currentSrc 或 <source>，并尽量从播放器配置里拿到真实地址 ===\n  function inspectVideoSources(video) {\n    try {\n      if (!video) return;\n      // currentSrc 优先\n      const cs = video.currentSrc || video.src || '';\n      if (cs) addVideoUrl(cs);\n\n      // <source> 标签\n      const srcs = video.querySelectorAll && video.querySelectorAll('source');\n      if (srcs && srcs.length) {\n        srcs.forEach(s => addVideoUrl(s.src));\n      }\n\n      // 一些播放器将urls写入 data-* 或 window 变量（尝试提取）\n      const container = video.closest && (video.closest('.artplayer-app') || video.parentElement);\n      if (container) {\n        // scan data- attributes\n        for (const attr of container.attributes || []) {\n          if (/data.*(src|url|play)/i.test(attr.name) && attr.value) {\n            addVideoUrl(attr.value);\n          }\n        }\n      }\n\n      // scan inline scripts for new Artplayer(...) 之类的初始化（非破坏性，纯字符串查找）\n      try {\n        for (const s of document.scripts) {\n          if (!s || !s.textContent) continue;\n          const txt = s.textContent;\n          // 简单匹配 m3u8/mp4 在初始化脚本中出现\n          const m = txt.match(/https?:\\/\\/[^'\"\\s]+?\\.(m3u8|mp4)[^\\s'\"]*/i);\n          if (m && m[0]) addVideoUrl(m[0]);\n        }\n      } catch (e) {}\n    } catch (e) {\n      console.warn('[ACG-HOOK] inspectVideoSources error', e);\n    }\n  }\n\n  // === Safe hooking of fetch/XHR (在播放器就绪后延迟挂载) ===\n  function safeHookNetwork() {\n    try {\n      // 双重保护：如果环境不允许或已有 hook，则不强行替换\n      if (window.__ACG_NET_HOOKED__) return;\n      window.__ACG_NET_HOOKED__ = true;\n\n      // Hook fetch\n      try {\n        if (window.fetch && !window.fetch.__acg_wrapped) {\n          const rawFetch = window.fetch.bind(window);\n          const wrapped = function (...args) {\n            try {\n              const url = typeof args[0] === 'string' ? args[0] : (args[0] && args[0].url);\n              if (url && /\\.(m3u8|mp4)(\\?|$)/i.test(url)) {\n                addVideoUrl(url);\n              }\n            } catch (e) {}\n            return rawFetch(...args);\n          };\n          wrapped.__acg_wrapped = true;\n          window.fetch = wrapped;\n          console.log('[ACG-HOOK] fetch wrapped');\n        }\n      } catch (e) {\n        console.warn('[ACG-HOOK] fetch hook failed', e);\n      }\n\n      // Hook XHR.open\n      try {\n        const X = XMLHttpRequest;\n        if (X && X.prototype && !X.prototype.open.__acg_wrapped) {\n          const rawOpen = X.prototype.open;\n          X.prototype.open = function (method, url) {\n            try {\n              if (typeof url === 'string' && /\\.(m3u8|mp4)(\\?|$)/i.test(url)) {\n                addVideoUrl(url);\n              }\n            } catch (e) {}\n            return rawOpen.apply(this, arguments);\n          };\n          X.prototype.open.__acg_wrapped = true;\n          console.log('[ACG-HOOK] XHR open wrapped');\n        }\n      } catch (e) {\n        console.warn('[ACG-HOOK] XHR hook failed', e);\n      }\n    } catch (e) {\n      console.warn('[ACG-HOOK] safeHookNetwork top', e);\n    }\n  }\n\n  // === 全屏时尝试锁横屏（手机） ===\n  function bindFullscreenLandscape(video) {\n    if (!IS_MOBILE) return;\n    try {\n      const onFull = () => {\n        try {\n          if (screen.orientation && screen.orientation.lock) {\n            screen.orientation.lock('landscape').catch(() => {});\n            console.log('[ACG-HOOK] requested orientation lock');\n          }\n        } catch (e) {}\n      };\n      document.addEventListener('fullscreenchange', onFull);\n      document.addEventListener('webkitfullscreenchange', onFull);\n      // 兼容某些播放器在 video 上触发全屏事件\n      video && video.addEventListener && video.addEventListener('fullscreenchange', onFull);\n    } catch (e) {\n      console.warn('[ACG-HOOK] bindFullscreenLandscape failed', e);\n    }\n  }\n\n  // === 主观察逻辑：等待播放器/视频出现，初次处理，然后延迟 hook 网络 ===\n  function startObserve() {\n    const t0 = Date.now();\n    const poll = setInterval(() => {\n      try {\n        // 超时保护\n        if (Date.now() - t0 > VIDEO_WAIT_TIMEOUT) {\n          clearInterval(poll);\n          console.warn('[ACG-HOOK] wait video timeout');\n          createDownloadUI(); // 仍创建 UI，用户可以手动尝试\n          return;\n        }\n\n        // 优先查找常见容器类与 video 标签\n        const video = document.querySelector('video');\n        const art = document.querySelector('.artplayer-app') || document.querySelector('.art-video-player') || null;\n\n        if (!video && !art) return;\n\n        // 找到后做一次被动读取（不替换任何原生 API）\n        console.log('[ACG-HOOK] video/player detected');\n        inspectVideoSources(video);\n        createDownloadUI();\n        bindFullscreenLandscape(video);\n\n        // 在安全延迟后才 hook 网络（降低检测概率）\n        setTimeout(() => {\n          safeHookNetwork();\n          // 若 hook 后视频请求马上出现，给几次检测机会\n          setTimeout(() => inspectVideoSources(video), 600);\n        }, SAFE_HOOK_DELAY);\n\n        clearInterval(poll);\n      } catch (e) {\n        console.warn('[ACG-HOOK] poll error', e);\n      }\n    }, OBS_POLL);\n  }\n\n  // 启动观察（在 load 之后再启动以更友好）\n  if (document.readyState === 'complete' || document.readyState === 'interactive') {\n    setTimeout(startObserve, 600);\n  } else {\n    window.addEventListener('DOMContentLoaded', () => setTimeout(startObserve, 600));\n    window.addEventListener('load', () => setTimeout(startObserve, 600));\n  }\n\n  // 额外：允许手动在控制台运行 window.__acg_force_inspect() 来即时扫描\n  window.__acg_force_inspect = function () {\n    try {\n      const v = document.querySelector('video');\n      inspectVideoSources(v);\n      createDownloadUI();\n      safeHookNetwork();\n    } catch (e) {}\n  };\n\n  console.log('[ACG-HOOK] injected (passive-mode)');\n})();","isHtml":false,"htmlPath":"","htmlFiles":[],"prefix":"","pcRepo":"PakePlus-v2.1.8","iosRepo":"PakePlus-iOS-v2.1.8","androidRepo":"PakePlus-Android-v2.1.8","more":{"windows":{"label":"","title":"ACG动漫","url":"https://www.acgkkkk.com/","userAgent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36","width":800,"height":600,"theme":null,"resizable":true,"fullscreen":false,"maximized":false,"minWidth":400,"minHeight":300,"maxWidth":1920,"maxHeight":1080,"decorations":true,"transparent":false,"titleBarStyle":"Visible","visible":true,"focus":true,"closable":true,"minimizable":true,"maximizable":true,"alwaysOnTop":false,"alwaysOnBottom":false,"center":false,"shadow":true,"skipTaskbar":false,"tabbingIdentifier":null,"parent":null,"dragDropEnabled":true,"browserExtensionsEnabled":false,"devtools":true,"contentProtected":false,"hiddenTitle":false,"incognito":false,"proxyUrl":null,"useHttpsScheme":false,"zoomHotkeysEnabled":false,"acceptFirstMouse":false,"create":false,"backgroundColor":null,"backgroundThrottling":null,"javascriptDisabled":false}},"phone":{"fullScreen":false,"safeArea":{"top":0,"bottom":0,"left":0,"right":0},"header":{"show":false,"title":"","backgroundColor":"","color":"","fontSize":16,"fontWeight":"bold","loading":false,"toolBar":false,"toolBarBackgroundColor":"","toolBarColor":"","toolBarFontSize":16,"toolBarFontWeight":"bold"},"siderMenu":{"show":false,"width":0,"backgroundColor":"","color":"","fontSize":16,"fontWeight":"bold","title":"","titleColor":"","titleFontSize":16,"titleFontWeight":"bold"},"tabBar":{"show":false,"backgroundColor":"","color":"","activeColor":"","fontSize":16,"fontWeight":"bold","tabBarItem":[]},"webview":{"userAgent":"","javaScriptEnabled":true,"domStorageEnabled":true,"allowFileAccess":true,"loadWithOverviewMode":true,"setSupportZoom":true,"clearCache":true}},"ios":{"name":"cbfcefea","showName":"ACG动漫","version":"1.0.4","webUrl":"https://www.acgkkkk.com/","id":"com.cbfcefea.pakeplus.ios","icon":"./app-icon.png","desc":"Package for personal use only, please do not use for commercial purposes（打包仅限个人使用，请勿传播或商业用途）","pubBody":"Package for personal use only, please do not use for commercial purposes（打包仅限个人使用，请勿传播或商业用途）","isHtml":false,"debug":false,"safeArea":"all"},"android":{"name":"cbfcefea","showName":"ACG动漫","version":"1.0.4","webUrl":"https://www.acgkkkk.com/","id":"com.cbfcefea.pakeplus.android","icon":"./app-icon.png","input":"./app-icon.png","output":"./res","rounded":true,"copyTo":"./app/src/main/res","androidResDir":"./app/src/main/res","desc":"Package for personal use only, please do not use for commercial purposes（打包仅限个人使用，请勿传播或商业用途）","pubBody":"Package for personal use only, please do not use for commercial purposes（打包仅限个人使用，请勿传播或商业用途）","isHtml":false,"debug":false,"safeArea":"all"},"desktop":{"name":"cbfcefea","showName":"ACG动漫","version":"1.0.4","id":"com.cbfcefea.pakeplus.desktop","desc":"打包仅限个人使用，请勿传播或商业用途，否则后果自负","webUrl":"https://www.acgkkkk.com/","iconPath":"../app-icon.png","inputPath":"../app-icon.png","tempPath":"./processed-image.png","icnsPath":"../src-tauri/icons/icon.icns","pubBody":"打包仅限个人使用，请勿传播或商业用途，否则后果自负","isHtml":false,"single":false,"state":true,"injectJq":false,"tauriApi":false,"buildMethod":"local","debug":true}}